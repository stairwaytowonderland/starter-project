# Secure code-server on EC2

A prototype setup generated by _AI_. Needs testing.

See [official docs](https://coder.com/docs/code-server) for reference material.

## 1. Network Security

**Security Group Rules:**

```txt
Inbound:
- Port 22 (SSH): Your IP only
- Port 443 (HTTPS): Your IP/CIDR range only (or 0.0.0.0/0 if needed)
- Block port 8080 (code-server default) from internet

Outbound:
- Allow all (or restrict to specific destinations)
```

**VPC Setup:**

- Use private subnet if possible, access via VPN/bastion
- If public subnet required, use strict security groups

## 2. TLS/HTTPS Setup

**Option A: Use code-server's built-in cert (quick but self-signed):**

```bash
code-server --cert --bind-addr 0.0.0.0:8080
```

**Option B: Use Let's Encrypt (recommended):**

```bash
# Install certbot
sudo apt install certbot

# Get certificate (requires domain pointing to EC2)
sudo certbot certonly --standalone -d yourdomain.com

# Run code-server with cert
code-server \
  --cert /etc/letsencrypt/live/yourdomain.com/fullchain.pem \
  --cert-key /etc/letsencrypt/live/yourdomain.com/privkey.pem \
  --bind-addr 0.0.0.0:443
```

**Option C: Use ALB/NLB with ACM certificate (best for production):**

- Terminate TLS at load balancer
- code-server runs HTTP on private subnet
- Health check on `/healthz`

## 3. Authentication

**Set strong password in config:**

```yaml
# ~/.config/code-server/config.yaml
bind-addr: 0.0.0.0:8080
auth: password
password: [generate-strong-password]
cert: true
```

**Or use password file:**

```bash
echo "your-strong-password" > ~/.config/code-server/password
chmod 600 ~/.config/code-server/password
```

**Consider adding GitHub OAuth** (requires proxy like oauth2-proxy)

## 4. Docker Security

**Run as non-root user:**

```dockerfile
USER vscode  # Already in your Dockerfile
```

**Limit container capabilities:**

```bash
docker run --cap-drop=ALL --cap-add=NET_BIND_SERVICE ...
```

**Use read-only filesystem where possible:**

```bash
docker run --read-only --tmpfs /tmp ...
```

## 5. EC2 Instance Security

**IAM Role:** Minimal permissions (CloudWatch logs, SSM only)

**IMDSv2 required:**

```bash
aws ec2 modify-instance-metadata-options \
  --instance-id i-xxx \
  --http-tokens required
```

**SSH hardening:** Disable password auth, use SSH keys only

**System updates:**

```bash
# In user-data or startup script
apt-get update && apt-get upgrade -y
```

## 6. Monitoring & Logging

**CloudWatch:**

- Enable detailed monitoring
- Stream code-server logs to CloudWatch
- Set alarms for unauthorized access attempts

**code-server logging:**

```bash
code-server --log trace 2>&1 | tee -a /var/log/code-server.log
```

## 7. Additional Hardening

**Firewall on instance:**

```bash
ufw allow 443/tcp
ufw enable
```

**Fail2ban for brute force protection:**

```bash
apt install fail2ban
# Configure to monitor code-server logs
```

**Session timeout in code-server config:**

```yaml
# Session timeout after 1 hour of inactivity
session-socket: /tmp/code-server-ipc.sock
```

## Quick Deployment Command

```bash
docker run -d \
  --name code-server \
  --cap-drop=ALL \
  --cap-add=NET_BIND_SERVICE \
  -p 443:8080 \
  -e PASSWORD="your-strong-password" \
  -v "$HOME/.config:/home/vscode/.config" \
  -v "$HOME/workspace:/home/vscode/workspace" \
  -v "/etc/letsencrypt:/etc/letsencrypt:ro" \
  your-codeserver-image:latest \
  --cert /etc/letsencrypt/live/yourdomain.com/fullchain.pem \
  --cert-key /etc/letsencrypt/live/yourdomain.com/privkey.pem \
  --bind-addr 0.0.0.0:8080
```

## Minimal Security Checklist

- [x] HTTPS enabled (not plain HTTP)
- [x] Strong password set
- [x] Security group restricts access to your IP
- [x] Non-root container user
- [x] EC2 instance in private subnet or with restrictive SG
- [x] CloudWatch logging enabled
- [x] IMDSv2 enforced
- [x] Regular security updates
